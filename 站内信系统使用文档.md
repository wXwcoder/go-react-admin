# 站内信系统使用文档

## 系统概述

站内信系统是一个完整的、基于现有框架的第三方客户消息通知解决方案，支持公告、系统消息、客户专属消息等多种消息类型，提供前后端完整实现。

## 功能特性

### 消息类型
- **公告(Announcement)**: 面向所有客户的公开消息
- **系统消息(Message)**: 系统级别的通知消息
- **客户专属消息**: 针对特定客户的个性化消息

### 消息状态
- **草稿(Draft)**: 待发布的消息
- **已发布(Published)**: 已发布的消息
- **已撤销(Revoked)**: 被撤销的消息

### 消息优先级
- 0-10级优先级系统
- 高优先级消息会优先展示
- 支持颜色标识不同优先级

## 数据库结构

### 核心表结构

#### 1. announcements 公告表
```sql
- id: 主键
- title: 公告标题
- content: 公告内容
- type: 公告类型(system/notice/maintenance/update)
- status: 状态(draft/published/revoked)
- priority: 优先级(0-10)
- expired_at: 过期时间
- read_count: 阅读次数
- created_at/updated_at/deleted_at: 时间戳
```

#### 2. announcement_reads 公告阅读记录表
```sql
- id: 主键
- announcement_id: 公告ID
- customer_id: 客户ID
- is_read: 是否已读
- read_time: 阅读时间
```

#### 3. messages 消息表
```sql
- id: 主键
- title: 消息标题
- content: 消息内容
- type: 消息类型(system/notice/private)
- status: 状态(draft/published/revoked)
- priority: 优先级
- target_type: 目标类型(all/customer/role)
- target_id: 目标ID
- expired_at: 过期时间
- read_count: 阅读次数
```

#### 4. customer_messages 客户消息表
```sql
- id: 主键
- message_id: 消息ID
- customer_id: 客户ID
- is_read: 是否已读
- read_time: 阅读时间
```

## API接口文档

### 管理端接口

#### 公告管理
- `GET /api/v1/admin/announcements` - 获取公告列表
- `POST /api/v1/admin/announcements` - 创建公告
- `PUT /api/v1/admin/announcements/:id` - 更新公告
- `DELETE /api/v1/admin/announcements/:id` - 删除公告
- `POST /api/v1/admin/announcements/:id/publish` - 发布公告
- `POST /api/v1/admin/announcements/:id/revoke` - 撤销公告

#### 消息管理
- `GET /api/v1/admin/messages` - 获取消息列表
- `POST /api/v1/admin/messages` - 创建消息
- `PUT /api/v1/admin/messages/:id` - 更新消息
- `DELETE /api/v1/admin/messages/:id` - 删除消息
- `POST /api/v1/admin/messages/:id/publish` - 发布消息
- `POST /api/v1/admin/messages/:id/revoke` - 撤销消息

#### 客户消息管理
- `GET /api/v1/admin/customer-messages` - 获取客户消息列表
- `POST /api/v1/admin/customer-messages/send` - 发送客户专属消息
- `DELETE /api/v1/admin/customer-messages/:id` - 删除客户消息

### 客户端接口

#### 公告接口
- `GET /api/v1/customer/announcements` - 获取客户公告列表
- `GET /api/v1/customer/announcements/:id` - 获取公告详情
- `POST /api/v1/customer/announcements/:id/read` - 标记公告已读
- `POST /api/v1/customer/announcements/batch-read` - 批量标记已读
- `GET /api/v1/customer/announcements/unread-count` - 获取未读数量

#### 消息接口
- `GET /api/v1/customer/messages` - 获取客户消息列表
- `GET /api/v1/customer/messages/:id` - 获取消息详情
- `POST /api/v1/customer/messages/:id/read` - 标记消息已读
- `POST /api/v1/customer/messages/batch-read` - 批量标记已读
- `DELETE /api/v1/customer/messages/:id` - 删除消息
- `GET /api/v1/customer/messages/unread-count` - 获取未读数量

## 前端使用指南

### 1. 客户消息中心

文件位置：`/web/src/pages/CustomerMessageCenter.jsx`

功能特点：
- 统一的公告和消息展示界面
- 支持按类型筛选
- 实时未读数量显示
- 批量操作支持
- 响应式设计

使用示例：
```javascript
import { customerMessageAPI } from '@/api/customer';

// 获取公告列表
const announcements = await customerMessageAPI.announcement.getList({
  page: 1,
  page_size: 10,
  is_read: false
});

// 标记为已读
await customerMessageAPI.announcement.markRead(announcementId);
```

### 2. 管理端页面

#### 公告管理页面
路径：`/admin/messages/announcements`
- 创建、编辑、发布公告
- 查看公告统计信息
- 撤销和删除操作

#### 消息管理页面
路径：`/admin/messages/list`
- 管理系统消息
- 批量操作支持
- 消息状态管理

#### 客户消息管理页面
路径：`/admin/messages/customer`
- 查看客户消息
- 发送客户专属消息
- 消息删除管理

### 3. 路由配置

系统已自动注册以下路由：
- `/messages` - 消息中心首页
- `/messages/list` - 消息管理
- `/messages/announcements` - 公告管理
- `/messages/customer` - 客户消息管理

## 安装和部署

### 1. 数据库初始化

执行数据库迁移文件：
```bash
# 创建表结构
mysql -u your_user -p your_database < server/migrations/20240101_create_announcements.sql

# 初始化数据
mysql -u your_user -p your_database < server/migrations/20240102_init_message_system.sql
```

### 2. 后端服务启动

确保所有服务已正确注册：
```go
// 在 main.go 中添加路由注册
api := api.NewCustomerMessageAPI()
api.RegisterRoutes(router)
```

### 3. 前端配置

系统已自动集成，无需额外配置。页面路径：
- 客户端：`/customer/messages`
- 管理端：`/admin/messages`

## 使用示例

### 1. 创建公告

```javascript
import { createAnnouncement } from '@/api/admin/message';

const announcement = await createAnnouncement({
  title: '系统维护通知',
  content: '系统将于今晚进行维护...',
  type: 'maintenance',
  priority: 8,
  expired_at: '2024-02-01T00:00:00Z'
});
```

### 2. 发送客户专属消息

```javascript
import { sendCustomerMessage } from '@/api/admin/message';

const message = await sendCustomerMessage({
  title: '欢迎注册',
  content: '欢迎成为我们的尊贵客户...',
  customer_ids: [1, 2, 3],
  priority: 5
});
```

### 3. 客户查看消息

```javascript
import { customerMessageAPI } from '@/api/customer';

// 获取消息列表
const messages = await customerMessageAPI.message.getList({
  page: 1,
  page_size: 20
});

// 获取未读数量
const unreadCount = await customerMessageAPI.message.getUnreadCount();
```

## 注意事项

1. **权限控制**：所有接口都有相应的权限验证
2. **数据安全**：敏感信息已做脱敏处理
3. **性能优化**：使用分页和索引优化查询
4. **用户体验**：支持实时未读数量显示
5. **兼容性**：支持移动端响应式设计

## 故障排查

### 常见问题

1. **消息不显示**
   - 检查消息状态是否为已发布
   - 确认消息未过期
   - 验证客户权限

2. **未读数量不准确**
   - 检查数据库触发器是否正常
   - 确认缓存已更新

3. **API调用失败**
   - 验证JWT Token有效性
   - 检查请求参数格式
   - 查看服务器日志

### 调试建议

- 使用浏览器开发者工具查看网络请求
- 检查数据库中的实际数据
- 查看服务器日志获取详细错误信息

## 扩展功能

### 计划中的功能

1. **消息模板**：支持消息模板管理
2. **定时发送**：支持定时发送消息
3. **消息统计**：详细的消息统计分析
4. **推送通知**：集成第三方推送服务
5. **消息搜索**：全文搜索功能

### 自定义扩展

系统采用模块化设计，易于扩展：
- 添加新的消息类型只需修改枚举值
- 自定义消息渲染组件
- 集成第三方通知渠道

## 技术支持

如遇到问题，请检查：
1. 数据库表是否正确创建
2. API路由是否正确注册
3. 前端组件是否正确导入
4. 权限配置是否正确

文档更新时间：2024年1月