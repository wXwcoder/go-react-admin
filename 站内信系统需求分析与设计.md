# 站内信系统需求分析与设计（第三方客户专用版）

## 1. 需求概述

### 1.1 业务背景
在动态数据管理平台中，需要建立一个专门针对第三方客户的站内信系统，用于管理员向第三方客户发送重要通知、公告，实现平台与第三方客户之间的高效沟通。该系统将作为平台与第三方客户沟通的重要渠道。

### 1.2 核心功能
- **管理端功能**：向第三方客户发送站内信、消息管理、查询统计
- **第三方客户功能**：独立的消息中心、接收平台消息、消息管理
- **消息类型**：公告类（全员广播）、客户专属消息（定向发送）

### 1.3 第三方客户集成要点
- **数据隔离**：第三方客户消息数据严格隔离
- **权限控制**：第三方客户只能接收和查看发送给自己的消息
- **独立管理**：第三方客户有独立的消息管理界面和API
- **批量支持**：支持向第三方客户群体批量发送消息

## 2. 详细需求分析

### 2.1 消息类型定义（基于实际实现优化）

基于实际代码实现，消息类型采用以下分类：

#### 2.1.1 系统消息类型（已存在）
- **系统消息** (`system`)：系统级通知，如账户安全提醒
- **通知公告** (`notification`)：平台公告类消息
- **警告消息** (`warning`)：需要客户注意的重要提醒
- **错误消息** (`error`)：系统错误或操作失败通知

#### 2.1.2 消息优先级
- **高优先级** (`high`)：紧急通知，需要立即处理
- **中优先级** (`medium`)：一般通知，可稍后查看
- **低优先级** (`low`)：普通信息，仅供参考

#### 2.1.3 消息范围机制
- **全客户广播**：面向所有第三方客户的公告消息
- **定向推送**：针对特定客户或客户群体的专属消息
- **实时推送**：客户专属消息支持实时推送
- **批量发送**：支持向多个客户同时发送相同消息

### 2.2 管理端功能需求

#### 2.2.1 消息发送
- **富文本编辑器**：支持文字格式化、链接、图片插入
- **消息类型选择**：
  - **公告类**：面向全体客户，无需选择具体客户，客户主动拉取
  - **客户专属**：需要选择目标客户，支持以下方式：
    - 按客户ID列表精确选择
    - 按客户状态筛选
    - 按注册时间筛选
- **发送机制**：
  - 公告类：创建消息记录即可，无需立即推送给客户
  - 客户专属：实时创建客户接收记录并推送
- **定时发送**：支持设置定时发送时间（仅适用于客户专属消息）
- **草稿保存**：支持保存草稿，后续继续编辑
- **预览功能**：发送前可预览消息效果
- **发送确认**：重要消息需要二次确认

#### 2.2.2 消息管理
- **列表展示**：
  - 消息标题、类型、发送时间、发送人
  - 公告类：显示发布时间和过期时间
  - 客户专属类：显示接收人数、已读率
  - 支持按类型（公告/专属）、时间、发送人筛选
  - 支持关键词搜索
  - 支持按消息状态筛选（草稿、已发布/已发送、已撤回）
- **详情查看**：
  - 消息完整内容
  - 公告类：显示已读客户数、阅读率统计
  - 客户专属类：显示已读/未读客户列表、阅读时间统计
  - 消息撤回记录
- **删除功能**：
  - 逻辑删除（可恢复）
  - 物理删除（彻底删除）
- **撤回功能**：消息发布/发送后一定时间内可撤回
- **重发功能**：支持撤回后重新编辑发布/发送

#### 2.2.3 客户消息管理
- **客户消息列表**：专门展示发送给第三方客户的消息
- **发送记录**：记录每次消息发送的详细日志
- **效果统计**：消息阅读率、客户活跃度统计

### 2.3 第三方客户功能需求

#### 2.3.1 客户消息中心
- **独立入口**：客户登录后的专属消息中心
- **消息列表**：
  - 合并显示公告类消息（主动拉取）和客户专属消息（定向推送）
  - 未读消息优先显示（包含未读公告和未读专属消息）
  - 显示消息类型图标（公告/专属）、标题、摘要、发送时间
  - 支持按消息类型（公告/专属）、时间范围、优先级筛选
  - 支持关键词搜索
  - 支持公告消息的手动刷新获取
- **消息详情**：
  - 完整内容展示
  - 标记已读功能（自动同步到对应的消息类型）
  - 公告消息支持一键全部已读

#### 2.3.2 客户消息操作
- **标记已读**：单条或批量标记已读
- **删除消息**：仅删除个人可见的消息记录
- **消息提醒**：浏览器通知、邮件提醒（可选）
- **消息搜索**：按标题、内容关键词搜索

## 3. 技术架构设计

### 3.1 数据库设计（基于实际实现优化）

基于实际代码实现，数据库结构如下：

#### 3.1.1 第三方客户表（customers）
```sql
CREATE TABLE customers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    password VARCHAR(255) NOT NULL COMMENT '密码',
    company_name VARCHAR(100) COMMENT '公司名称',
    contact_person VARCHAR(50) COMMENT '联系人',
    phone VARCHAR(20) COMMENT '联系电话',
    status ENUM('active', 'inactive', 'suspended') DEFAULT 'active' COMMENT '状态',
    last_login_at DATETIME COMMENT '最后登录时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email),
    INDEX idx_status (status)
);```

#### 3.1.2 第三方客户消息表（customer_messages）
```sql
CREATE TABLE customer_messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(255) NOT NULL COMMENT '消息标题',
    content TEXT COMMENT '消息内容',
    type ENUM('system', 'notification', 'warning', 'error') DEFAULT 'notification' COMMENT '消息类型',
    priority ENUM('high', 'medium', 'low') DEFAULT 'medium' COMMENT '优先级',
    customer_id BIGINT NOT NULL COMMENT '接收客户ID',
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    read_time DATETIME COMMENT '阅读时间',
    is_deleted BOOLEAN DEFAULT FALSE COMMENT '是否删除',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    INDEX idx_customer (customer_id),
    INDEX idx_customer_read (customer_id, is_read),
    INDEX idx_created_at (created_at)
);```

### 3.2 API接口设计

#### 3.2.1 管理端接口
- **消息管理**
  - `POST /api/v1/admin/messages` - 创建消息（支持公告类/客户专属类）
  - `PUT /api/v1/admin/messages/:id` - 更新消息
  - `DELETE /api/v1/admin/messages/:id` - 删除消息
  - `GET /api/v1/admin/messages` - 获取消息列表（支持按类型筛选）
  - `GET /api/v1/admin/messages/:id` - 获取消息详情
  - `POST /api/v1/admin/messages/:id/send` - 发送消息（公告类直接发布，客户专属类创建接收记录）
  - `POST /api/v1/admin/messages/:id/cancel` - 撤回消息

- **客户消息管理**
  - `GET /api/v1/admin/customer-messages` - 获取客户专属消息列表
  - `POST /api/v1/admin/customer-messages/send` - 向指定客户发送消息
  - `GET /api/v1/admin/customer-messages/stats` - 获取客户专属消息统计
  - `GET /api/v1/admin/announcements` - 获取公告消息列表

#### 3.2.2 第三方客户端接口（基于实际实现优化）

基于实际代码实现，第三方客户端接口已按以下方式实现：

- **客户认证**（已实现）
  - `POST /api/v1/customer/register` - 客户注册
  - `POST /api/v1/customer/login` - 客户登录
  - `POST /api/v1/customer/logout` - 客户登出
  - `POST /api/v1/customer/refresh-token` - 刷新token
  - `GET /api/v1/customer/profile` - 获取客户个人信息
  - `PUT /api/v1/customer/profile` - 更新客户个人信息
  - `PUT /api/v1/customer/password` - 更新客户密码
  - `POST /api/v1/customer/reset-password` - 重置客户密码

- **客户消息管理**（已实现）
  - `GET /api/v1/customer/messages` - 获取第三方客户消息列表
  - `GET /api/v1/customer/messages/:id` - 获取消息详情
  - `PUT /api/v1/customer/messages/:id/read` - 标记消息为已读
  - `PUT /api/v1/customer/messages/batch-read` - 批量标记消息为已读
  - `GET /api/v1/customer/messages/unread-count` - 获取未读消息数量
  - `DELETE /api/v1/customer/messages/:id` - 删除消息

- **管理端客户消息管理**（已实现）
  - `POST /api/v1/admin/customer-messages` - 管理员创建客户消息
  - `POST /api/v1/admin/customer-messages/batch` - 管理员批量创建客户消息

### 3.3 公告消息拉取机制详细设计

#### 3.3.1 拉取策略
- **首次拉取**：客户登录后自动触发公告消息检查
- **增量拉取**：基于上次拉取时间戳，仅获取新公告
- **手动刷新**：客户可手动触发公告消息刷新
- **分页加载**：支持分页获取历史公告消息
- **过期过滤**：自动过滤已过期的公告消息

#### 3.3.2 已读状态管理
- **公告已读**：使用独立的公告已读状态表，避免为每个客户创建接收记录
- **状态同步**：客户标记公告已读后，实时同步到服务端
- **批量操作**：支持公告消息的一键全部已读
- **数据清理**：定期清理过期的已读状态数据

#### 3.3.3 性能优化
- **缓存机制**：
  - 公告消息内容缓存（Redis，5分钟TTL）
  - 客户已读状态缓存（Redis，用户会话级别）
  - CDN缓存静态公告内容
- **查询优化**：
  - 使用索引优化公告消息查询
  - 避免N+1查询问题
  - 支持游标分页
- **并发控制**：
  - 限制单个客户的拉取频率（1次/秒）
  - 使用分布式锁防止重复拉取

#### 3.3.4 数据一致性
- **最终一致性**：公告消息的已读状态采用最终一致性模型
- **冲突解决**：使用时间戳解决并发更新冲突
- **重试机制**：网络异常时的重试策略（指数退避）

### 3.4 前端架构设计

#### 3.4.1 管理端组件结构
```
src/pages/admin/message/
├── components/
│   ├── MessageEditor.jsx           // 消息编辑器
│   ├── MessageList.jsx             // 消息列表
│   ├── MessageDetail.jsx           // 消息详情
│   ├── CustomerSelector.jsx        // 客户选择器
│   └── MessageStats.jsx            // 消息统计
├── hooks/
│   ├── useMessageList.js           // 消息列表逻辑
│   ├── useMessageDetail.js         // 消息详情逻辑
│   └── useMessageStats.js          // 消息统计逻辑
└── index.jsx                       // 主页面
```

#### 3.3.2 第三方客户前端结构（基于实际实现优化）
```
src/pages/customer/
├── CustomerMessages.jsx            // 客户消息中心主页面（已存在）
├── components/
│   ├── MessageList.jsx             // 消息列表组件（对应CustomerMessages中的表格）
│   ├── MessageDetailModal.jsx      // 消息详情弹窗
│   ├── MessageFilters.jsx          // 消息筛选组件
│   └── MessageActions.jsx          // 消息操作组件
├── hooks/
│   ├── useCustomerMessages.js      // 客户消息列表逻辑
│   ├── useMessageDetail.js         // 消息详情逻辑
│   └── useUnreadCount.js           // 未读消息数量逻辑
└── utils/
    ├── messageFormatters.js         // 消息格式化工具
    └── messageFilters.js            // 消息筛选工具
```

#### 3.3.3 现有实现分析
基于已存在的 `CustomerMessages.jsx`，第三方客户前端已实现以下功能：

**已实现功能：**
- ✅ **消息列表展示**：表格形式展示所有消息，包含分页
- ✅ **未读消息提醒**：顶部显示未读消息数量徽章
- ✅ **消息状态管理**：已读/未读状态区分显示
- ✅ **消息详情查看**：点击查看消息详情弹窗
- ✅ **批量操作**：全部已读、批量标记已读
- ✅ **消息类型标识**：系统消息、通知公告等类型标签
- ✅ **优先级显示**：高/中/低优先级标签
- ✅ **时间格式化**：友好的时间显示格式
- ✅ **搜索筛选**：支持按标题、内容关键词搜索
- ✅ **删除功能**：单条消息删除确认

**技术特点：**
- 使用Ant Design组件库实现
- React Hooks状态管理
- 响应式设计适配移动端
- 实时更新未读消息数量
- 自动标记已读（查看详情时）

**消息数据结构：**
```javascript
{
  id: number,
  title: string,
  content: string,
  type: 'system' | 'notification' | 'warning' | 'error',
  priority: 'high' | 'medium' | 'low',
  is_read: boolean,
  created_at: string,
  // 其他元数据...
}
```

## 4. 权限与安全设计

### 4.1 权限控制矩阵（基于实际实现）

| 角色 | 消息创建 | 消息发送 | 消息查看 | 消息编辑 | 消息删除 | 客户认证 | 个人信息管理 |
|------|----------|----------|----------|----------|----------|----------|--------------|
| 超级管理员 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 系统管理员 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 客户管理员 | ✓ | ✓ | ✓ | ✓ | ✗ | ✓ | ✓ |
| 第三方客户 | ✗ | ✗ | ✓(仅自身) | ✗ | ✓(仅自身) | ✓(仅自身) | ✓(仅自身) |

### 4.2 数据隔离机制（基于实际实现）

#### 4.2.1 客户专属消息（已实现）
- **数据库隔离**：使用customer_id字段确保数据严格隔离
- **API隔离**：独立的客户API端点（/api/customer/*）
- **权限验证**：所有客户API都基于JWT token验证客户身份
- **数据过滤**：查询时自动根据customer_id过滤数据

#### 4.2.2 客户认证系统（已实现）
- **注册隔离**：客户注册信息独立存储在customers表
- **登录验证**：JWT token包含客户ID和过期时间
- **个人信息**：客户只能访问和修改自己的信息
- **密码管理**：客户可以重置自己的密码（通过邮件验证）

### 4.3 安全措施（已实现）

#### 4.3.1 接口安全（已实现）
- **JWT认证**：基于customer_auth.go实现的客户认证系统
- **权限验证**：每个客户API都验证customer_id匹配
- **参数验证**：所有输入参数通过GORM和自定义验证
- **错误处理**：统一的错误响应格式，避免敏感信息泄露

#### 4.3.2 数据安全（已实现）
- **数据隔离**：customer_id字段确保严格的数据隔离
- **访问控制**：每个API操作都验证客户身份
- **密码安全**：密码使用bcrypt哈希存储
- **敏感信息**：敏感信息（如密码）不在响应中返回

#### 4.3.3 客户认证安全（已实现）
- **密码加密**：bcrypt密码哈希存储
- **Token管理**：JWT token包含客户ID和过期时间
- **会话验证**：支持登录状态验证
- **权限检查**：每个操作都检查客户权限

## 5. 开发任务列表

### 5.1 后端开发任务（基于实际实现状态更新）

#### 5.1.1 数据库层（已实现）
- [x] 创建第三方客户表（customers）- 已存在
- [x] 创建第三方客户消息表（customer_messages）- 已存在
- [x] 创建对应的GORM模型 - 已存在
- [x] 添加数据库迁移脚本 - 已存在init.sql
- [ ] 优化消息查询性能（添加复合索引）
- [ ] 支持消息批量操作优化

#### 5.1.2 业务逻辑层（部分实现）
- [x] 客户认证服务（CustomerAuthService）- 已实现
  - [x] 客户注册/登录/登出
  - [x] 个人信息管理
  - [x] 密码重置功能
- [x] 客户消息服务（CustomerMessageService）- 已实现
  - [x] 获取客户消息列表
  - [x] 获取消息详情
  - [x] 标记消息已读（单条/批量）
  - [x] 获取未读消息数量
  - [x] 删除客户消息
- [ ] 消息类型扩展
  - [ ] 支持公告类消息（广播模式）
  - [ ] 支持定时消息发送

#### 5.1.3 API接口层（已实现）
- [x] 客户认证API（customer_auth.go）- 完整实现
  - [x] 注册/登录/登出接口
  - [x] 个人信息管理接口
  - [x] 密码管理接口
- [x] 客户消息API（customer_message.go）- 完整实现
  - [x] 消息列表查询接口
  - [x] 消息详情接口
  - [x] 消息状态管理接口
  - [x] 消息删除接口
- [x] 管理端客户消息API - 已实现
  - [x] 管理员创建客户消息
  - [x] 管理员批量创建客户消息
- [ ] API文档完善（Swagger更新）
- [ ] 接口测试用例补充

### 5.2 前端开发任务

#### 5.2.1 管理端开发
- [ ] 更新消息编辑器组件
  - [ ] 添加客户筛选功能
- [ ] 更新消息列表组件
  - [ ] 显示目标用户类型
  - [ ] 添加客户消息统计展示
- [ ] 更新权限控制逻辑

#### 5.2.2 第三方客户前端优化（基于实际实现）

**已实现功能**（CustomerMessages.jsx）：
- [x] 消息列表展示（表格形式，支持分页）
- [x] 未读消息提醒（顶部徽章显示）
- [x] 消息状态管理（已读/未读区分显示）
- [x] 消息详情查看（点击查看详情弹窗）
- [x] 批量操作（全部已读、批量标记已读）
- [x] 消息类型标识（系统/通知/警告/错误标签）
- [x] 优先级显示（高/中/低优先级标签）
- [x] 时间格式化（友好时间显示）
- [x] 搜索筛选（按标题、内容关键词搜索）
- [x] 删除功能（单条消息删除确认）

**待优化功能**：
- [ ] **架构重构**：将CustomerMessages.jsx拆分为模块化组件
  - [ ] 提取独立MessageList组件
  - [ ] 提取MessageDetailModal组件
  - [ ] 提取MessageFilters组件
- [ ] **功能增强**：
  - [ ] 添加消息类型筛选器
  - [ ] 添加时间范围筛选
  - [ ] 添加优先级筛选
  - [ ] 支持消息导出功能
- [ ] **用户体验优化**：
  - [ ] 添加消息已读状态动画
  - [ ] 优化空状态提示
  - [ ] 改进移动端响应式体验
- [ ] **性能优化**：
  - [ ] 实现消息列表虚拟滚动
  - [ ] 添加消息缓存机制
  - [ ] 优化API调用频率

### 5.3 集成与测试任务（基于实际实现状态更新）

#### 5.3.1 系统集成（已实现）
- [x] 站内信系统集成第三方客户支持
  - [x] 客户认证系统集成（基于customer_auth.go实现）
  - [x] 客户消息系统集成（基于customer_message.go实现）
  - [x] 客户数据隔离机制实现
- [x] 第三方客户认证中间件（已实现）
- [x] 客户专用JWT密钥和过期时间配置（已实现）
- [x] 客户权限验证机制（已实现）

#### 5.3.2 测试（待补充）
- [ ] 单元测试
  - [ ] 客户认证服务测试（基于customer_auth.go）
  - [ ] 客户消息服务测试（基于customer_message.go）
  - [ ] 数据隔离验证测试
- [ ] 集成测试
  - [ ] 客户认证API测试（注册/登录/个人信息）
  - [ ] 客户消息API测试（完整功能测试）
  - [ ] 权限控制测试
- [ ] 前端测试
  - [ ] CustomerMessages.jsx组件测试
  - [ ] 客户消息交互测试
  - [ ] 响应式布局测试
- [ ] 性能测试
  - [ ] 客户消息查询性能测试
  - [ ] 批量消息处理性能测试

### 5.4 部署与配置

#### 5.4.1 环境配置
- [ ] 更新Docker配置支持客户消息系统
- [ ] 配置客户专用的子域名（如：customer.example.com）
- [ ] 配置客户专用的SSL证书
- [ ] 更新反向代理配置

#### 5.4.2 监控与日志
- [ ] 添加客户消息操作日志
- [ ] 添加客户登录失败监控
- [ ] 添加客户消息推送监控
- [ ] 实现客户活跃度统计

## 6. 性能优化

### 6.1 数据库优化
- **索引优化**：为customer_id和message_id创建复合索引
- **分页优化**：使用游标分页处理大量客户消息
- **查询优化**：使用预加载减少N+1查询问题
- **分区表**：考虑按时间分区存储历史消息

### 6.2 缓存优化
- **客户消息缓存**：缓存客户的未读消息数量
- **客户列表缓存**：缓存活跃客户列表
- **消息内容缓存**：缓存热门消息的详细内容
- **CDN优化**：客户静态资源使用CDN加速

### 6.3 批量处理优化
- **批量插入**：使用批量插入优化大量客户消息发送
- **异步处理**：使用消息队列异步处理客户消息
- **并发控制**：限制同时处理的客户数量
- **失败重试**：实现失败消息的重试机制

## 7. 扩展功能规划

### 7.1 高级消息功能
- **消息模板**：支持客户专用的消息模板
- **个性化内容**：支持客户姓名等变量的动态替换
- **A/B测试**：支持不同客户群体的消息内容测试
- **定时清理**：客户消息的自动清理策略

### 7.2 客户互动功能
- **消息反馈**：客户可对消息进行反馈
- **消息评分**：客户可对消息的有用性进行评分
- **快捷回复**：预设客户快捷回复模板
- **消息收藏**：客户可收藏重要消息

### 7.3 统计与分析
- **客户活跃度**：基于消息互动的客户活跃度分析
- **消息效果**：不同消息类型的客户响应率统计
- **客户画像**：基于消息偏好的客户画像分析
- **业务洞察**：消息数据的业务价值挖掘

## 8. 开发优先级

### 8.1 第一阶段（基础集成）
1. 更新数据库设计支持第三方客户
2. 实现基础的客户消息发送功能
3. 创建客户消息接收API
4. 优化现有CustomerMessages.jsx组件

### 8.2 第二阶段（功能完善）
1. 客户消息统计功能
2. 客户消息批量操作
3. 客户消息搜索和筛选增强

### 8.3 第三阶段（高级功能）
1. 客户消息模板系统
2. 客户消息推送优化
3. 客户消息统计分析
4. 客户互动功能

### 8.4 第四阶段（性能优化）
1. 大量客户消息性能优化
2. 客户消息缓存系统
3. 客户消息监控告警
4. 客户消息自动化运维

## 9. 风险与应对措施

### 9.1 技术风险
- **数据隔离风险**：通过严格的权限验证和数据过滤机制
- **性能风险**：通过缓存、分页、异步处理等方式优化
- **安全风险**：通过独立的认证系统和权限控制
- **兼容风险**：通过充分的测试和渐进式部署

### 9.2 业务风险
- **客户体验风险**：通过用户测试和反馈收集机制
- **消息滥用风险**：通过发送频率限制和内容审核
- **数据泄露风险**：通过加密存储和访问日志
- **系统稳定性**：通过监控告警和故障恢复机制

### 9.3 应对措施
- **灰度发布**：先小范围测试客户功能
- **监控告警**：实时监控客户消息系统运行状态
- **备份策略**：定期备份客户消息数据
- **应急响应**：建立快速响应机制处理系统异常