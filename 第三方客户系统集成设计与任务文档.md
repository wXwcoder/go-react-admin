# 第三方客户系统集成设计与任务文档

## 1. 需求概述

### 1.1 业务背景
基于现有站内信系统，需要集成第三方客户系统，实现第三方消费者用户端功能。该系统需要与现有的管理后台用户体系严格隔离，确保数据安全和权限控制。

### 1.2 核心需求
- **数据隔离**：第三方消费者客户数据与现有用户数据完全隔离
- **权限控制**：第三方客户仅限访问消费者端页面，管理员可管理第三方客户
- **账号体系**：使用独立的`customer`表存储第三方客户账号数据
- **功能范围**：注册、登录、大厅页面等基础功能

## 2. 系统架构设计

### 2.1 数据架构

#### 2.1.1 第三方客户账号表（customers）
```sql
CREATE TABLE customers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT '邮箱',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    phone VARCHAR(20) COMMENT '手机号',
    real_name VARCHAR(50) COMMENT '真实姓名',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    status ENUM('active', 'banned', 'pending') DEFAULT 'pending' COMMENT '账号状态',
    last_login_at DATETIME COMMENT '最后登录时间',
    login_count INT DEFAULT 0 COMMENT '登录次数',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME COMMENT '软删除时间',
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 2.1.2 第三方客户站内信关联表（customer_messages）
```sql
CREATE TABLE customer_messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id BIGINT NOT NULL COMMENT '消息ID',
    customer_id BIGINT NOT NULL COMMENT '客户ID',
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    read_time DATETIME COMMENT '阅读时间',
    is_deleted BOOLEAN DEFAULT FALSE COMMENT '是否删除',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    INDEX idx_customer_message (customer_id, message_id),
    INDEX idx_message_customer (message_id, customer_id)
);
```

### 2.2 权限架构

#### 2.2.1 权限模型
- **系统管理员**：可管理所有第三方客户账号
- **第三方客户管理员**：仅能管理自己权限范围内的客户
- **第三方客户**：仅能访问消费者端功能

#### 2.2.2 RBAC配置
```ini
# 新增第三方客户相关权限
p, admin, /api/v1/admin/customers/*, *
p, admin, /api/v1/admin/customer_roles/*, *
p, customer_manager, /api/v1/admin/customers, GET
p, customer_manager, /api/v1/admin/customers/:id, GET
p, customer_manager, /api/v1/admin/customers/:id/status, PUT
p, customer, /api/v1/customer/*, *
```

### 2.3 API接口设计

#### 2.3.1 管理端接口
- `POST /api/v1/admin/customers` - 创建第三方客户账号
- `PUT /api/v1/admin/customers/:id` - 更新客户信息
- `DELETE /api/v1/admin/customers/:id` - 删除客户账号
- `GET /api/v1/admin/customers` - 获取客户列表（分页、筛选）
- `GET /api/v1/admin/customers/:id` - 获取客户详情
- `PUT /api/v1/admin/customers/:id/status` - 修改账号状态
- `POST /api/v1/admin/customers/:id/ban` - 封禁账号
- `POST /api/v1/admin/customers/:id/unban` - 解封账号

#### 2.3.2 第三方客户接口
- `POST /api/v1/customer/auth/register` - 客户注册
- `POST /api/v1/customer/auth/login` - 客户登录
- `POST /api/v1/customer/auth/logout` - 客户登出
- `GET /api/v1/customer/profile` - 获取个人信息
- `PUT /api/v1/customer/profile` - 更新个人信息
- `POST /api/v1/customer/password/reset` - 重置密码
- `GET /api/v1/customer/messages` - 获取站内信列表
- `GET /api/v1/customer/messages/:id` - 获取站内信详情
- `PUT /api/v1/customer/messages/:id/read` - 标记已读

## 3. 前端架构设计

### 3.1 管理端组件结构
```
src/pages/admin/third-party-customers/
├── components/
│   ├── CustomerList.jsx          // 客户列表
│   ├── CustomerDetail.jsx        // 客户详情
│   ├── CustomerForm.jsx          // 客户表单
│   └── CustomerStatus.jsx        // 状态管理
├── hooks/
│   ├── useCustomerList.js        // 客户列表逻辑
│   └── useCustomerDetail.js      // 客户详情逻辑
└── index.jsx                    // 主页面
```

### 3.2 第三方客户前端结构
```
src/pages/customer/
├── auth/
│   ├── Login.jsx                // 登录页面
│   ├── Register.jsx             // 注册页面
│   └── ForgotPassword.jsx       // 忘记密码
├── dashboard/
│   ├── Dashboard.jsx            // 客户大厅
│   └── components/
│       ├── Welcome.jsx          // 欢迎组件
│       ├── QuickActions.jsx     // 快捷操作
│       └── RecentMessages.jsx   // 最近消息
├── profile/
│   ├── Profile.jsx              // 个人中心
│   └── components/
│       ├── ProfileForm.jsx      // 个人资料表单
│       └── PasswordForm.jsx     // 密码修改表单
├── message-center/
│   ├── MessageList.jsx          // 消息列表
│   ├── MessageDetail.jsx        // 消息详情
│   └── components/
│       ├── MessageFilters.jsx   // 消息筛选
│       └── MessageActions.jsx   // 消息操作
└── layout/
    ├── CustomerLayout.jsx       // 客户布局
    └── components/
        ├── Header.jsx           // 头部导航
        ├── Sidebar.jsx          // 侧边栏
        └── Footer.jsx           // 底部
```

## 4. 开发任务列表

### 4.1 后端开发任务

#### 4.1.1 数据库层
- [ ] 创建第三方客户相关数据表
- [ ] 创建对应的GORM模型
  - [ ] Customer模型
  - [ ] CustomerMessage模型
- [ ] 添加数据库迁移脚本
- [ ] 创建索引优化查询性能

#### 4.1.2 业务逻辑层
- [ ] 创建第三方客户管理服务（CustomerService）
  - [ ] 实现客户创建逻辑
  - [ ] 实现客户信息更新逻辑
  - [ ] 实现客户状态管理逻辑（封禁/解封）
  - [ ] 实现客户查询逻辑（分页、筛选、搜索）
- [ ] 创建第三方客户认证服务（CustomerAuthService）
  - [ ] 实现客户注册逻辑
  - [ ] 实现客户登录逻辑
  - [ ] 实现密码重置逻辑
  - [ ] 实现JWT token生成和验证
- [ ] 创建第三方客户消息服务（CustomerMessageService）
  - [ ] 实现客户消息查询逻辑
  - [ ] 实现消息已读状态更新逻辑

#### 4.1.3 API接口层
- [ ] 创建管理端第三方客户管理API
  - [ ] 客户列表API（分页、筛选、搜索）
  - [ ] 客户详情API
  - [ ] 客户创建API
  - [ ] 客户更新API
  - [ ] 客户状态修改API
- [ ] 创建第三方客户认证API
  - [ ] 注册API
  - [ ] 登录API
  - [ ] 登出API
  - [ ] 个人信息获取API
  - [ ] 个人信息更新API
- [ ] 创建第三方客户消息API
  - [ ] 消息列表API
  - [ ] 消息详情API
  - [ ] 标记已读API
- [ ] 添加接口权限验证
- [ ] 添加接口文档（Swagger）
- [ ] 添加接口测试用例

### 4.2 前端开发任务

#### 4.2.1 管理端开发
- [ ] 创建第三方客户管理路由和页面
- [ ] 实现客户列表组件（分页、筛选、搜索）
- [ ] 实现客户详情组件
- [ ] 实现客户表单组件（新增/编辑）
- [ ] 实现客户状态管理功能
- [ ] 实现批量操作功能
- [ ] 集成API调用
- [ ] 添加权限控制

#### 4.2.2 第三方客户前端开发
- [ ] 创建客户认证页面
  - [ ] 注册页面
  - [ ] 登录页面
  - [ ] 忘记密码页面
- [ ] 创建客户大厅页面
  - [ ] 欢迎组件
  - [ ] 快捷操作组件
  - [ ] 最近消息组件
- [ ] 创建个人中心页面
  - [ ] 个人资料修改
  - [ ] 密码修改
- [ ] 创建消息中心页面
  - [ ] 消息列表
  - [ ] 消息详情
  - [ ] 消息筛选和搜索
- [ ] 创建客户布局组件
  - [ ] 头部导航
  - [ ] 侧边栏
  - [ ] 底部
- [ ] 集成API调用
- [ ] 添加路由守卫

### 4.3 集成与测试任务

#### 4.3.1 系统集成
- [ ] 修改站内信系统支持第三方客户
  - [ ] 更新消息发送逻辑支持第三方客户
  - [ ] 更新消息查询逻辑支持第三方客户
- [ ] 创建独立的第三方客户认证中间件
- [ ] 配置独立的JWT密钥和过期时间
- [ ] 实现数据隔离验证机制

#### 4.3.2 测试
- [ ] 编写单元测试
  - [ ] 第三方客户服务测试
  - [ ] 认证服务测试
  - [ ] 消息服务测试
- [ ] 编写集成测试
  - [ ] 管理端API测试
  - [ ] 客户端API测试
  - [ ] 权限控制测试
- [ ] 编写前端测试
  - [ ] 管理端组件测试
  - [ ] 客户端组件测试
- [ ] 性能测试
  - [ ] 大量客户注册性能测试
  - [ ] 消息推送性能测试

### 4.4 部署与配置

#### 4.4.1 环境配置
- [ ] 更新Docker配置支持第三方客户系统
- [ ] 配置独立的第三方客户域名（如：customer.example.com）
- [ ] 配置SSL证书
- [ ] 配置反向代理

#### 4.4.2 监控与日志
- [ ] 添加第三方客户操作日志
- [ ] 添加登录失败监控
- [ ] 添加异常告警机制

## 5. 安全设计

### 5.1 认证安全
- 使用JWT token进行身份验证
- 密码使用bcrypt加密存储
- 登录失败次数限制
- 密码复杂度要求

### 5.2 权限安全
- 基于RBAC的权限控制
- API级别的权限验证
- 数据访问权限隔离
- 操作审计日志

### 5.3 数据安全
- 敏感数据加密存储
- SQL注入防护
- XSS攻击防护
- CSRF攻击防护

## 6. 性能优化

### 6.1 数据库优化
- 合理创建索引
- 分页查询优化
- 连接池配置优化
- 读写分离（可选）

### 6.2 缓存优化
- 客户信息缓存
- 登录状态缓存
- 消息列表缓存
- CDN静态资源缓存

### 6.3 前端优化
- 路由懒加载
- 组件按需加载
- 图片懒加载
- 请求防抖节流

## 7. 开发优先级

### 7.1 第一阶段（基础功能）
1. 第三方客户数据表设计
2. 第三方客户注册/登录功能
3. 基础的客户管理后台
4. 简单的客户大厅页面

### 7.2 第二阶段（完善功能）
1. 客户状态管理（封禁/解封）
2. 客户个人中心
3. 客户消息中心
4. 安全加固

### 7.3 第三阶段（高级功能）
1. 客户批量操作
2. 客户行为分析
3. 客户消息推送优化
4. 客户数据统计

## 8. 风险与注意事项

### 8.1 技术风险
- 数据隔离的完整性
- 大量客户注册的性能问题
- 跨域访问的安全问题

### 8.2 业务风险
- 客户信息泄露风险
- 恶意注册风险
- 权限越界风险

### 8.3 应对措施
- 严格的权限验证机制
- 客户注册频率限制
- 敏感操作二次验证
- 定期安全审计
- 数据备份策略

## 9. 验收标准

### 9.1 功能验收
- [ ] 第三方客户可正常注册、登录
- [ ] 管理员可管理第三方客户账号
- [ ] 第三方客户可正常接收站内信
- [ ] 数据完全隔离，无交叉访问

### 9.2 性能验收
- [ ] 注册响应时间 < 2秒
- [ ] 登录响应时间 < 1秒
- [ ] 客户列表查询响应时间 < 1秒
- [ ] 支持1000+并发用户

### 9.3 安全验收
- [ ] 通过安全测试
- [ ] 权限控制正确
- [ ] 敏感数据加密
- [ ] 操作日志完整